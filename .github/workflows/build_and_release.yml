name: Build and Release

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          
      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ninja-build libgtk-3-dev libmpv-dev mpv patchelf

      - name: Enable Linux Desktop
        run: flutter config --enable-linux-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build Linux app
        run: flutter build linux --release --build-name=1.0.${{ github.run_number }} --build-number=${{ github.run_number }}

      - name: Create portable Linux package
        run: |
          cd build/linux/x64/release/bundle
          
          # Create a launch script
          cat > ffmpeg-converter << 'EOF'
          #!/bin/bash
          SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
          cd "$SCRIPT_DIR"
          export LD_LIBRARY_PATH="$SCRIPT_DIR/lib:$LD_LIBRARY_PATH"
          exec "$SCRIPT_DIR/flutter_test_application" "$@"
          EOF
          
          chmod +x ffmpeg-converter
          
          cd ..
          tar -czf ../../../../FFmpeg-Converter-Linux-x86_64-Portable.tar.gz -C bundle .
          
      - name: Create README for Linux
        run: |
          cat > LINUX_README.txt << 'EOF'
          FFmpeg Converter - Linux Portable Version
          ==========================================
          
          Installation:
          1. Extract the tar.gz file: tar -xzf FFmpeg-Converter-Linux-x86_64-Portable.tar.gz
          2. Run: ./ffmpeg-converter
          
          Or double-click 'ffmpeg-converter' in your file manager.
          
          Requirements:
          - GTK3
          - libmpv
          
          Install on Ubuntu/Debian: sudo apt-get install libgtk-3-0 libmpv1
          Install on Fedora: sudo dnf install gtk3 mpv-libs
          Install on Arch: sudo pacman -S gtk3 mpv
          EOF

      - name: Upload Linux Build
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            FFmpeg-Converter-Linux-x86_64-Portable.tar.gz
            LINUX_README.txt

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Enable Windows Desktop
        run: flutter config --enable-windows-desktop

      - name: Get dependencies
        run: flutter pub get

      - name: Build Windows app
        run: flutter build windows --release --build-name=1.0.${{ github.run_number }} --build-number=${{ github.run_number }}

      - name: Rename executable for clarity
        run: |
          cd build\windows\x64\runner\Release
          
          # Rename the main executable to a user-friendly name
          if (Test-Path "flutter_test_application.exe") {
            Rename-Item -Path "flutter_test_application.exe" -NewName "FFmpeg-Converter.exe"
            Write-Host "âœ… Renamed to FFmpeg-Converter.exe"
          }
          
          # Create README
          $readme = @'
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘   FFmpeg Converter - Windows Portable       â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸš€ CÃCH CHáº Y:
          
          Double-click vÃ o: FFmpeg-Converter.exe
          
          ÄÆ¡n giáº£n váº­y thÃ´i!

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          ğŸ“Œ Táº O SHORTCUT:
          
          1. Chuá»™t pháº£i vÃ o FFmpeg-Converter.exe
          2. Chá»n "Send to" â†’ "Desktop (create shortcut)"
          3. Giá» báº¡n cÃ³ thá»ƒ cháº¡y tá»« Desktop!

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          â„¹ï¸  LÆ¯U Ã:
          
          - Giá»¯ táº¥t cáº£ files trong cÃ¹ng thÆ° má»¥c nÃ y
          - KhÃ´ng xÃ³a cÃ¡c file .dll vÃ  thÆ° má»¥c data/
          - CÃ³ thá»ƒ copy toÃ n bá»™ thÆ° má»¥c sang mÃ¡y khÃ¡c

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          ğŸ“¦ Portable Version - No Installation Required
          '@
          
          Set-Content -Path "README.txt" -Value $readme -Encoding UTF8
          
          Write-Host "âœ… Created README.txt"
        shell: pwsh

      - name: Compress Windows Build
        run: |
          # Compress from inside the Release folder so files are at root when extracted
          Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath FFmpeg-Converter-Windows-Portable.zip -Force
          Write-Host "âœ… Created portable ZIP package"
        shell: pwsh

      - name: Upload Windows Portable
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: FFmpeg-Converter-Windows-Portable.zip

  build-web:
    name: Build Web & Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build Web
        run: flutter build web --release --base-href /FFmpeg-Converter-App/

      - name: Fix Source Map 404 Errors
        run: |
          # Create empty source map files to prevent 404 errors in browser console
          echo '{"version":3, "file": "flutter.js", "sources": [], "names": [], "mappings": ""}' > build/web/flutter.js.map
          echo '{"version":3, "file": "flutter_bootstrap.js", "sources": [], "names": [], "mappings": ""}' > build/web/flutter_bootstrap.js.map
          echo "âœ… Created dummy source maps"

      - name: Create .nojekyll
        run: touch build/web/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/web

  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Get dependencies
        run: flutter pub get

      - name: Build Android APK
        run: flutter build apk --release --build-name=1.0.${{ github.run_number }} --build-number=${{ github.run_number }}
        env:
          JAVA_HOME: ${{ env.JAVA_HOME_17_X64 }}
        
      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-build
          path: build/app/outputs/flutter-apk/app-release.apk

  create-release:
    name: Create Release
    needs: [build-linux, build-windows, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: linux-build
      
      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: windows-build

      - name: Download Android Artifact
        uses: actions/download-artifact@v4
        with:
          name: android-build

      - name: Rename APK for clarity
        run: mv app-release.apk FFmpeg-Converter-Android.apk

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: |
            ## ğŸ¬ FFmpeg Converter v1.0.${{ github.run_number }}
            
            **Táº£i vá» vÃ  cháº¡y ngay - KhÃ´ng cáº§n cÃ i Ä‘áº·t!**
            
            ### ğŸ“¥ Táº£i vá» cho há»‡ Ä‘iá»u hÃ nh cá»§a báº¡n:
            
            | Platform | File | KÃ­ch thÆ°á»›c | CÃ¡ch dÃ¹ng |
            |----------|------|------------|-----------|
            | ğŸªŸ **Windows** | `FFmpeg-Converter-Windows-Portable.zip` | ~150MB | Giáº£i nÃ©n â†’ Cháº¡y **FFmpeg-Converter.exe** |
            | ğŸ§ **Linux** | `FFmpeg-Converter-Linux-x86_64-Portable.tar.gz` | ~200MB | Giáº£i nÃ©n â†’ Cháº¡y `./ffmpeg-converter` |
            | ğŸ¤– **Android** | `FFmpeg-Converter-Android.apk` | ~150MB | CÃ i Ä‘áº·t APK |
            
            ---
            
            ### ğŸªŸ Windows - SiÃªu Ä‘Æ¡n giáº£n!
            
            **BÆ°á»›c 1:** Táº£i file `FFmpeg-Converter-Windows-Portable.zip`
            
            **BÆ°á»›c 2:** Giáº£i nÃ©n (chuá»™t pháº£i â†’ Extract All)
            
            **BÆ°á»›c 3:** Má»Ÿ thÆ° má»¥c vá»«a giáº£i nÃ©n, báº¡n sáº½ tháº¥y:
            ```
            ğŸ“ FFmpeg-Converter/
            â”œâ”€â”€ ğŸ“„ FFmpeg-Converter.exe  â† Double-click vÃ o Ä‘Ã¢y!
            â”œâ”€â”€ ğŸ“„ README.txt
            â”œâ”€â”€ ğŸ“„ cÃ¡c file .dll
            â””â”€â”€ ğŸ“ data/
            ```
            
            **BÆ°á»›c 4:** Double-click vÃ o `FFmpeg-Converter.exe` â†’ Xong!
            
            ğŸ’¡ **Táº¡o shortcut Desktop:**
            - Chuá»™t pháº£i vÃ o `FFmpeg-Converter.exe`
            - Chá»n `Send to` â†’ `Desktop (create shortcut)`
            - Giá» cháº¡y tá»« Desktop luÃ´n!
            
            ---
            
            ### ğŸ§ Linux - Dá»… dÃ ng khÃ´ng kÃ©m!
            
            ```bash
            # BÆ°á»›c 1: Giáº£i nÃ©n
            tar -xzf FFmpeg-Converter-Linux-x86_64-Portable.tar.gz
            cd FFmpeg-Converter/
            
            # BÆ°á»›c 2: Cháº¡y!
            ./ffmpeg-converter
            ```
            
            **Cáº§n cÃ i dependencies (náº¿u chÆ°a cÃ³):**
            ```bash
            # Ubuntu/Debian
            sudo apt-get install libgtk-3-0 libmpv1
            
            # Fedora
            sudo dnf install gtk3 mpv-libs
            
            # Arch Linux
            sudo pacman -S gtk3 mpv
            ```
            
            ğŸ’¡ **Táº¡o Desktop launcher:** Xem hÆ°á»›ng dáº«n trong `LINUX_README.txt`
            
            ---
            
            ### ğŸ¤– Android
            
            ```
            1. Táº£i file FFmpeg-Converter-Android.apk
            2. Má»Ÿ file APK Ä‘á»ƒ cÃ i Ä‘áº·t
            3. Cho phÃ©p "Install from unknown sources" náº¿u Ä‘Æ°á»£c há»i
            ```
            
            âš ï¸ **LÆ°u Ã½ quan trá»ng:** PhiÃªn báº£n Android **KHÃ”NG há»— trá»£ chuyá»ƒn Ä‘á»•i video** do thÆ° viá»‡n FFmpeg Kit Ä‘Ã£ bá»‹ discontinued. 
            
            ğŸ‘‰ Äá»ƒ chuyá»ƒn Ä‘á»•i video, vui lÃ²ng dÃ¹ng:
            - ğŸŒ **Web version** (khuyÃªn dÃ¹ng nháº¥t): [GitHub Pages](https://yourusername.github.io/FFmpeg-Converter-App/)
            - ğŸªŸ Windows portable
            - ğŸ§ Linux portable
            
            ---
            
            ### âœ¨ TÃ­nh nÄƒng:
            
            - âœ… Chuyá»ƒn Ä‘á»•i video sang MP4, WebM, AVI, MKV, MOV...
            - âœ… Äiá»u chá»‰nh codec (H.264, H.265, VP9...)
            - âœ… Thay Ä‘á»•i bitrate, Ä‘á»™ phÃ¢n giáº£i
            - âœ… Xem trÆ°á»›c video trÆ°á»›c/sau chuyá»ƒn Ä‘á»•i
            - âœ… Giao diá»‡n thÃ¢n thiá»‡n, dá»… dÃ¹ng
            - âœ… Äa ngÃ´n ngá»¯: ğŸ‡¬ğŸ‡§ English | ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t | ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª | ğŸ‡©ğŸ‡ª Deutsch
            
            ---
            
            ### ğŸŒ DÃ¹ng ngay trÃªn Web - KhÃ´ng cáº§n táº£i!
            
            Truy cáº­p: **[https://yourusername.github.io/FFmpeg-Converter-App/](https://yourusername.github.io/FFmpeg-Converter-App/)**
            
            - âœ… KhÃ´ng cáº§n cÃ i Ä‘áº·t
            - âœ… Cháº¡y trÃªn má»i há»‡ Ä‘iá»u hÃ nh (Windows, Mac, Linux, Android, iOS)
            - âœ… Táº¥t cáº£ xá»­ lÃ½ diá»…n ra trÃªn mÃ¡y báº¡n (privacy-first)
            
            ---
            
            ### ğŸ“Š So sÃ¡nh cÃ¡c phiÃªn báº£n:
            
            | TÃ­nh nÄƒng | Windows | Linux | Android | Web |
            |-----------|---------|-------|---------|-----|
            | Chuyá»ƒn Ä‘á»•i video | âœ… | âœ… | âŒ | âœ… |
            | Portable/No install | âœ… | âœ… | âŒ | âœ… |
            | Tá»‘c Ä‘á»™ | âš¡âš¡âš¡ | âš¡âš¡âš¡ | - | âš¡âš¡ |
            | Video preview | âœ… | âœ… | âœ… | âœ… |
            
            ---
            
            **ğŸ‰ Khuyáº¿n nghá»‹:** 
            - Desktop users: Táº£i Windows/Linux portable
            - DÃ¹ng thá»­ nhanh: DÃ¹ng Web version
            - Mobile: DÃ¹ng Web version trÃªn browser
            
            **Built with:** Flutter ğŸ’™ | **Build date:** ${{ github.event.head_commit.timestamp }}
          draft: false
          prerelease: false
          files: |
            FFmpeg-Converter-Linux-x86_64-Portable.tar.gz
            LINUX_README.txt
            FFmpeg-Converter-Windows-Portable.zip
            FFmpeg-Converter-Android.apk
            app-release.apk
